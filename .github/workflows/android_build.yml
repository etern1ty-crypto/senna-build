name: Build EvoX Senna (Extreme Slim)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
    # 1. ЧИСТКА МЕСТА (Extreme Edition)
    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        # УМЕНЬШИЛИ SWAP ДО 1 ГБ (Было 10). Это вернет 9 ГБ диска.
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        overprovision-lvm: 'true'

    # 2. Получаем твои файлы (папку senna)
    - name: Checkout Repo
      uses: actions/checkout@v3
      with:
        path: my_repo

    # 3. Установка минимума софта
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        git config --global user.name "Bot"
        git config --global user.email "bot@example.com"

    # 4. Инициализация с фильтрами (Экономим ~5 ГБ)
    - name: Repo Init
      run: |
        mkdir evox
        cd evox
        export PATH=~/bin:$PATH
        # --groups=all,-notdefault,-device,-darwin,-x86,-mips
        # НЕ качаем эмуляторы, мак-версии и прочий мусор
        repo init -u https://github.com/Evolution-X/manifest -b bq1 --depth=1 --groups=all,-notdefault,-device,-darwin,-x86,-mips

    # 5. Манифест
    - name: Create Local Manifest
      run: |
        cd evox
        mkdir -p .repo/local_manifests
        cat <<EOF > .repo/local_manifests/senna.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <remote name="lod" fetch="https://github.com/lineage-ovaltine-dev" revision="lineage-23.0"/>
          <remote name="lod-gl" fetch="https://gitlab.com/lineage-ovaltine-dev/proprietary_vendor_oneplus" revision="lineage-23"/>
          <remote name="q2" fetch="https://github.com/Quantom2" revision="lineage-23.0"/>
          
          <project name="android_kernel_oneplus_sm8450" path="kernel/oneplus/sm8450" remote="lod" revision="lineage-23.0" />
          <project name="android_kernel_oneplus_sm8450-devicetrees" path="kernel/oneplus/sm8450-devicetrees" remote="lod" revision="lineage-23.0" />
          <project name="android_kernel_oneplus_sm8450-modules" path="kernel/oneplus/sm8450-modules" remote="lod" revision="lineage-23.0" />
          
          <project name="android_device_realme_senna" path="device/realme/senna" remote="q2" revision="lineage-23.0" />
          <project name="android_device_oneplus_sm8450-common" path="device/oneplus/sm8450-common" remote="lod" revision="lineage-23.0" />
          
          <project name="ovaltine" path="vendor/realme/senna" remote="lod-gl" revision="lineage-23" />
          <project name="sm8450-common" path="vendor/oneplus/sm8450-common" remote="lod-gl" revision="lineage-23" />
          <project name="Luk1337/android_vendor_extra" path="vendor/extra" remote="github" revision="master" />
        </manifest>
        EOF

    # 6. Синхронизация
    - name: Repo Sync
      run: |
        cd evox
        export PATH=~/bin:$PATH
        # --optimized-fetch и --prune помогают экономить
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --optimized-fetch --prune
        
        # УДАЛЯЕМ .repo СРАЗУ ЖЕ! Это освободит ~40 ГБ.
        rm -rf .repo

    # 7. Замена файлов
    - name: Install Device Tree
      run: |
        rm -rf evox/device/realme/senna/*
        echo "Copying files..."
        # Пробуем скопировать из senna/ или tree/ (на всякий случай)
        cp -r my_repo/senna/* evox/device/realme/senna/ || cp -r my_repo/tree/* evox/device/realme/senna/

    # 8. Ребрендинг
    - name: Convert Lineage -> EvoX
      run: |
        cd evox/device/realme/senna
        if [ -f "lineage_senna.mk" ]; then
            mv lineage_senna.mk evolution_senna.mk
        fi
        find . -type f -exec sed -i 's/lineage_senna/evolution_senna/g' {} + || true
        find . -type f -exec sed -i 's/vendor\/lineage/vendor\/evolution/g' {} + || true
        
        echo "PRODUCT_MAKEFILES := \$(LOCAL_DIR)/evolution_senna.mk" > AndroidProducts.mk
        echo "COMMON_LUNCH_CHOICES := evolution_senna-userdebug" >> AndroidProducts.mk
        
        # Отключаем оверлеи Lineage, чтобы не крашилось
        if [ -d "overlay-lineage" ]; then
            rm -rf overlay-lineage
        fi

    # 9. Сборка
    - name: Build ROM
      run: |
        cd evox
        export PATH=~/bin:$PATH
        export USE_CCACHE=0
        source build/envsetup.sh
        lunch evolution_senna-userdebug
        m evolution

    # 10. Загрузка
    - name: Upload Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        files: evox/out/target/product/senna/evolution*.zip
        name: Evolution X Unofficial
        tag_name: ${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
