name: Build EvoX for Senna
on:
  workflow_dispatch: # Запуск кнопкой вручную

jobs:
  build:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write

    steps:
    # 1. ЧИСТКА МЕСТА (ГЛАВНЫЙ ХАК)
    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 10240
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    # 2. Установка инструментов
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        git config --global user.name "Bot"
        git config --global user.email "bot@example.com"

    # 3. Скачивание исходников (Shallow Sync для экономии места)
    - name: Repo Init & Sync
      run: |
        mkdir evox
        cd evox
        export PATH=~/bin:$PATH
        # Инициализируем Android 14 (UDC) с глубиной 1 (без истории, экономит 50% места)
        repo init -u https://github.com/Evolution-X/manifest -b udc --depth=1
        
        # Создаем манифест Никиты
        mkdir -p .repo/local_manifests
        cat <<EOF > .repo/local_manifests/senna.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <remote name="lod" fetch="https://github.com/lineage-ovaltine-dev" revision="lineage-23.0"/>
          <remote name="lod-gl" fetch="https://gitlab.com/lineage-ovaltine-dev/proprietary_vendor_oneplus" revision="lineage-23"/>
          <remote name="q2" fetch="https://github.com/Quantom2" revision="lineage-23.0"/>
          
          <project name="android_kernel_oneplus_sm8450" path="kernel/oneplus/sm8450" remote="lod" revision="lineage-23.0" />
          <project name="android_kernel_oneplus_sm8450-devicetrees" path="kernel/oneplus/sm8450-devicetrees" remote="lod" revision="lineage-23.0" />
          <project name="android_kernel_oneplus_sm8450-modules" path="kernel/oneplus/sm8450-modules" remote="lod" revision="lineage-23.0" />
          <project name="android_device_realme_senna" path="device/realme/senna" remote="q2" revision="lineage-23.0" />
          <project name="android_device_oneplus_sm8450-common" path="device/oneplus/sm8450-common" remote="lod" revision="lineage-23.0" />
          <project name="ovaltine" path="vendor/realme/senna" remote="lod-gl" revision="lineage-23" />
          <project name="sm8450-common" path="vendor/oneplus/sm8450-common" remote="lod-gl" revision="lineage-23" />
          <project name="Luk1337/android_vendor_extra" path="vendor/extra" remote="github" revision="master" />
        </manifest>
        EOF

        # Синхронизация (очень долго)
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
        
        # ВАЖНО: Удаляем папку .repo чтобы освободить 40 ГБ места под сборку
        rm -rf .repo

    # 4. Ребрендинг Lineage -> Evolution (Автоматически)
    - name: Fix Device Tree
      run: |
        cd evox/device/realme/senna
        
        # Переименовываем makefile
        mv lineage_senna.mk evolution_senna.mk
        
        # Меняем содержимое makefile
        sed -i 's/lineage_senna/evolution_senna/g' evolution_senna.mk
        sed -i 's|vendor/lineage/config/common_full_phone.mk|vendor/evolution/config/common_full_phone.mk|g' evolution_senna.mk
        
        # Меняем AndroidProducts.mk
        echo "PRODUCT_MAKEFILES := \$(LOCAL_DIR)/evolution_senna.mk" > AndroidProducts.mk
        echo "COMMON_LUNCH_CHOICES := evolution_senna-userdebug" >> AndroidProducts.mk

    # 5. Сборка
    - name: Build ROM
      run: |
        cd evox
        export PATH=~/bin:$PATH
        export USE_CCACHE=0 # Нет места для кэша
        source build/envsetup.sh
        lunch evolution_senna-userdebug
        m evolution

    # 6. Загрузка результата в Релизы GitHub
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: evox/out/target/product/senna/evolution*.zip
        name: Evolution X Unofficial
        tag_name: ${{ github.run_id }}
        body: "Automated build"
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
